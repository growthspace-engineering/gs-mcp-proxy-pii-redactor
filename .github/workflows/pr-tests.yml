name: ðŸ§ªðŸ“Š PR Unit Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - beta

jobs:
  test:
    name: ðŸ§ª Run Unit Tests & ðŸ“ˆ Coverage
    runs-on: ubuntu-latest
    permissions:
      checks: write
      contents: write
      pages: write
      id-token: write
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ§ª Run unit tests with coverage
        id: test-run
        continue-on-error: true
        run: npm run test:cov

      - name: ðŸ“¥ Download base branch coverage
        id: base-coverage
        uses: dawidd6/action-download-artifact@v3
        with:
          name: coverage-report-${{ github.base_ref }}
          path: base-coverage/
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: release.yml
          branch: ${{ github.base_ref }}
          if_no_artifact_found: ignore
        continue-on-error: true

      - name: ðŸ“ Extract base coverage values
        id: base-values
        run: |
          if [ -f base-coverage/test-results/gs-mcp-proxy-pii-redactor/coverage/coverage-summary.json ]; then
            BASE_STATEMENTS=$(node -e "const s=require('./base-coverage/test-results/gs-mcp-proxy-pii-redactor/coverage/coverage-summary.json'); console.log(s.total.statements.pct || 0)")
            BASE_BRANCHES=$(node -e "const s=require('./base-coverage/test-results/gs-mcp-proxy-pii-redactor/coverage/coverage-summary.json'); console.log(s.total.branches.pct || 0)")
            BASE_FUNCTIONS=$(node -e "const s=require('./base-coverage/test-results/gs-mcp-proxy-pii-redactor/coverage/coverage-summary.json'); console.log(s.total.functions.pct || 0)")
            BASE_LINES=$(node -e "const s=require('./base-coverage/test-results/gs-mcp-proxy-pii-redactor/coverage/coverage-summary.json'); console.log(s.total.lines.pct || 0)")
            
            echo "base_statements=$BASE_STATEMENTS" >> $GITHUB_OUTPUT
            echo "base_branches=$BASE_BRANCHES" >> $GITHUB_OUTPUT
            echo "base_functions=$BASE_FUNCTIONS" >> $GITHUB_OUTPUT
            echo "base_lines=$BASE_LINES" >> $GITHUB_OUTPUT
            echo "has_base=true" >> $GITHUB_OUTPUT
          else
            echo "base_statements=0" >> $GITHUB_OUTPUT
            echo "base_branches=0" >> $GITHUB_OUTPUT
            echo "base_functions=0" >> $GITHUB_OUTPUT
            echo "base_lines=0" >> $GITHUB_OUTPUT
            echo "has_base=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸš€ Deploy test reports to GitHub Pages
        if: github.event_name == 'pull_request' && always()
        id: deploy-reports
        uses: ./.github/actions/deploy-github-pages
        with:
          test-results-path: test-results/gs-mcp-proxy-pii-redactor
          project-name: gs-mcp-proxy-pii-redactor-pr-${{ github.event.pull_request.number }}
          coverage-path: test-results/gs-mcp-proxy-pii-redactor/coverage/coverage-summary.json
          jest-results-path: test-results/gs-mcp-proxy-pii-redactor/jest-results.json
          deployment-type: pr
          pr-number: ${{ github.event.pull_request.number }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“ Add coverage report to workflow summary
        if: github.event_name == 'pull_request' && always()
        run: |
          echo "### ðŸ“Š Test & Coverage Results" >> $GITHUB_STEP_SUMMARY
          echo "[![Tests Status](${{ steps.deploy-reports.outputs.test-badge }})](${{ steps.deploy-reports.outputs.report-url }}) [![Code Coverage](${{ steps.deploy-reports.outputs.coverage-badge }})](${{ steps.deploy-reports.outputs.coverage-url }})" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "Results for PR #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- [View Test Report](${{ steps.deploy-reports.outputs.report-url }})" >> $GITHUB_STEP_SUMMARY
          echo "- [View Coverage Report](${{ steps.deploy-reports.outputs.coverage-url }})" >> $GITHUB_STEP_SUMMARY
          echo "- [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Generate coverage summary with diff
          if [ -f test-results/gs-mcp-proxy-pii-redactor/coverage/coverage-summary.json ]; then
            HAS_BASE="${{ steps.base-values.outputs.has_base }}"
            
            echo "### ðŸ“ˆ Coverage Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$HAS_BASE" = "true" ]; then
              echo "| Metric | Base (${{ github.base_ref }}) | PR | Change |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|------------------------|----|----|" >> $GITHUB_STEP_SUMMARY
              
              # Calculate diffs and format table
              node -e "
                const pr = require('./test-results/gs-mcp-proxy-pii-redactor/coverage/coverage-summary.json').total;
                const base = {
                  statements: parseFloat('${{ steps.base-values.outputs.base_statements }}'),
                  branches: parseFloat('${{ steps.base-values.outputs.base_branches }}'),
                  functions: parseFloat('${{ steps.base-values.outputs.base_functions }}'),
                  lines: parseFloat('${{ steps.base-values.outputs.base_lines }}')
                };
                
                const formatChange = (prVal, baseVal) => {
                  const diff = prVal - baseVal;
                  const sign = diff >= 0 ? '+' : '';
                  const emoji = diff > 0 ? 'ðŸŸ¢' : diff < 0 ? 'ðŸ”´' : 'âšª';
                  return `${emoji} ${sign}${diff.toFixed(2)}%`;
                };
                
                console.log(`| **Statements** | ${base.statements.toFixed(2)}% | ${pr.statements.pct.toFixed(2)}% | ${formatChange(pr.statements.pct, base.statements)} |`);
                console.log(`| **Branches** | ${base.branches.toFixed(2)}% | ${pr.branches.pct.toFixed(2)}% | ${formatChange(pr.branches.pct, base.branches)} |`);
                console.log(`| **Functions** | ${base.functions.toFixed(2)}% | ${pr.functions.pct.toFixed(2)}% | ${formatChange(pr.functions.pct, base.functions)} |`);
                console.log(`| **Lines** | ${base.lines.toFixed(2)}% | ${pr.lines.pct.toFixed(2)}% | ${formatChange(pr.lines.pct, base.lines)} |`);
              " >> $GITHUB_STEP_SUMMARY
            else
              echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
              node -e "const s=require('./test-results/gs-mcp-proxy-pii-redactor/coverage/coverage-summary.json'); const t=s.total; console.log(`| **Statements** | ${t.statements.pct}% |`); console.log(`| **Branches** | ${t.branches.pct}% |`); console.log(`| **Functions** | ${t.functions.pct}% |`); console.log(`| **Lines** | ${t.lines.pct}% |`);" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "â„¹ï¸ Base branch coverage not available yet (first PR or base branch hasn't run coverage). Showing PR coverage only." >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> These reports are automatically generated and deployed to GitHub Pages for this PR." >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“‹ Report test and coverage results
        uses: dorny/test-reporter@v2
        if: always()
        with:
          name: Test & Coverage Results (gs-mcp-proxy-pii-redactor)
          path: test-results/gs-mcp-proxy-pii-redactor/junit.xml
          reporter: jest-junit
          fail-on-error: 'true'
          token: ${{ secrets.GITHUB_TOKEN }}
          list-suites: 'all'
          list-tests: 'failed'
          max-annotations: 10
