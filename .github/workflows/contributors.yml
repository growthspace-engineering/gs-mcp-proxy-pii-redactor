name: Add Contributors

on:
  pull_request_target:
    types:
      - closed
    branches:
      - main
      - beta

jobs:
  add-contributor:
    # Only run when PR is merged
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: ðŸª¾ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.base.ref }}
          token: ${{ secrets.PUBLIC_RELEASE_BOT_TOKEN }}
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ”§ Configure git
        run: |
          git config --local user.email "gsBot@growthspace.com"
          git config --local user.name "gr0wth-b0t"
      
      - name: ðŸ“Š Determine contributor status
        id: contrib_status
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const login = String(process.env.PR_AUTHOR || '').toLowerCase();
          const cfg = JSON.parse(fs.readFileSync('.all-contributorsrc', 'utf8'));
          const contributors = Array.isArray(cfg.contributors) ? cfg.contributors : [];
          const entry = contributors.find(c => String(c.login || '').toLowerCase() === login);
          const isForbidden = ['gr0wth-b0t', 'allcontributors[bot]', 'allcontributors'].includes(login);
          const found = Boolean(entry) && !isForbidden;
          const hasCode = found && Array.isArray(entry.contributions) && entry.contributions.includes('code');
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `found=${found}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `has_code=${hasCode}\n`);
          NODE
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
      
      - name: ðŸš€ Add contributor
        if: steps.contrib_status.outputs.found != 'true' || steps.contrib_status.outputs.has_code != 'true'
        run: |
          # Add the PR author as a code contributor
          npm run contributors:add -- ${{ github.event.pull_request.user.login }} code
          
          # Generate the updated README
          npm run contributors:generate
          
          # Check if files were modified
          if git diff --quiet .all-contributorsrc README.md; then
            echo "No changes to commit - contributor already exists"
            echo "contributor_added=false" >> $GITHUB_OUTPUT
          else
            echo "contributor_added=true" >> $GITHUB_OUTPUT
          fi
        id: add_contributor
      
      - name: ðŸš€ Commit and push changes
        if: steps.add_contributor.outputs.contributor_added == 'true'
        run: |
          git add .all-contributorsrc README.md
          git commit -m "docs: add @${{ github.event.pull_request.user.login }} as a contributor"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.PUBLIC_RELEASE_BOT_TOKEN }}

