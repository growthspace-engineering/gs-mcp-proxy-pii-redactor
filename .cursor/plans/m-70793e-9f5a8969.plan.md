<!-- 9f5a8969-deb6-4ccf-9c14-97e0a6aa96a0 f37a240d-6fad-44e2-bc4d-df369a675a23 -->
# MCP Proxy – Versioned Roadmap and Execution Plan (2.x)

This plan translates the earlier design into a repo-anchored, actionable roadmap for agents and contributors. It starts at the current version (2.1.0-beta.5), uses semantic versioning rigor (patch/minor/major), includes test requirements for each step, and identifies places where technology choices must be made by the user before implementation.

---

## Baseline and SemVer Policy

- Current baseline: 2.1.0-beta.5 (`@growthspace-engineering/gs-mcp-proxy-pii-redactor`)
- Policy for planned changes:
- Patch (2.1.x): bug fixes, doc/CLI polish, log/error clarity. No API/config changes.
- Minor (2.x.0): additive features, new endpoints/config fields with backward compatibility on by default.
- Major (3.0.0): breaking config changes, default behavior changes, or removals.

---

## Repositories

- Core (this repo): `gs-mcp-proxy-pii-redactor`
- New (to be created when milestones arrive):
  - Extension repo: `mcp-proxy-vscode` (VS Code + Cursor UI; debug panels, config UI)
  - Optional NER/PII tester repo: `mcp-proxy-pii-tester` (offline CLI + optional JS NER)

Notes:

- Tech selection for extension framework, analytics storage, NER runtime, schema libs is deferred to user confirmation per milestone.

---

## Milestones

### 2.1.x (Patch-only maintenance)

- Scope:
- Logging/doc fixes and non-functional improvements only.
- Tests:
- Smoke e2e: `GET /` returns `{status:"ok"}` (existing e2e covers)
- Unit: no new APIs; ensure unchanged.

### 2.2.0 (Minor) — Config Validation + Minimal Debug API

- Deliverables:
- Config schema validation at startup (warn-only by default; opt-in fail-hard via option).
- Debug endpoints:
- `GET /config` (sanitized effective config, no secrets/headers values)
- `GET /metrics.json` (basic counters: requests by client, errors, redactions)
- Key files:
- `src/config/types.ts` (unchanged types; new schema lives alongside)
- `src/config/config.service.ts` (hook in validation; redact secrets for /config view)
- `src/app.controller.ts` or new `src/debug/debug.controller.ts` for debug endpoints
- Tech choices (defer selection):
- Schema: JSON Schema (AJV) vs zod-based runtime validation
- Metrics counters: in-memory vs lightweight library
- Tests:
- Unit: config validation happy/missing variables; warn vs fail-hard behavior.
- Unit: `sanitizeConfig` removes secrets and header values.
- e2e: `GET /config` returns effective config sans secrets.
- e2e: `GET /metrics.json` shows non-negative counters; increments after a sample proxied call.
- Acceptance:
- Default run does not break existing configs; opt-in failure works via setting.

### 2.3.0 (Minor) — Analytics Store + Event Schema + Exporter

- Deliverables:
- Central event interface for: tool_call, redaction_applied, error, duration.
- Pluggable local store (JSONL or SQLite) behind interface.
- Optional batch HTTP exporter.
- Bridge existing `AuditLogger` to emit structured events (no change to current files-on-disk behavior).
- Key files:
- New `src/analytics/` (interface, store adapters, exporter)
- Touch points: `src/mcp/mcp-client-wrapper.ts`, `src/redaction/*`, `src/mcp/mcp-server.service.ts`
- Tech choices (defer selection):
- Storage: JSONL vs SQLite
- Export: simple HTTP vs message queue
- Tests:
- Unit: event objects validate against schema.
- Unit: store write/read roundtrip; rotate/compaction behavior (if JSONL).
- e2e: tool call produces analytics events; opt-out leaves events empty.
- Acceptance:
- Feature is additive and off unless enabled in config.

### 2.4.0 (Minor) — Project Configs & Discovery

- Deliverables:
- CLI: `mcp-proxy init --project` writes `./.mcp-proxy/config.json`
- Discovery: effective config resolution `derived > project > global > defaults` while preserving `--config` behavior
- Key files:
- `src/main.ts` (CLI command + help)
- `src/config/config.service.ts` (resolver helper)
- Tech choices (defer selection):
- Merge semantics for future “derived” MCP child configs; initial pass only defines order.
- Tests:
- Unit: resolver selects project over global; respects `--config` override.
- e2e: running with only global; then with project; both work.
- Acceptance:
- No behavior change without project config present.

### 2.5.0 (Minor) — Performance Recommendation Endpoint

- Deliverables:
- `GET /performance/recommendation` runs cached micro-benchmark (redaction pass + transport no-op) and returns recommendation {class, suggested_mode, rate}.
- Config fields for `pii_second_pass` (additive; off by default).
- Key files:
- `src/perf/perf.service.ts` (benchmark + cache)
- `src/perf/perf.controller.ts` (endpoint)
- `src/redaction/redaction.service.ts` (reusable benchmark unit)
- Tech choices (defer selection):
- Clock/metrics lib vs manual `process.hrtime`/`performance.now()`
- Tests:
- Unit: benchmark returns ms in expected range for stub text.
- e2e: endpoint returns cached value; can be forced to refresh.
- Acceptance:
- Endpoint exists and returns deterministic structure.

### 2.6.0 (Minor) — PII Testing Suite (CLI)

- Deliverables:
- Config: `pii_test_profiles` schema (additive).
- CLI: `mcp-proxy pii-test --all --report=reports/pii.json` executes profiles against configured servers/tools.
- Output: machine-readable JSON report for CI.
- Key files:
- `src/cli/pii-test.ts` (CLI entry; wire in commander)
- `src/pii-test/runner.ts`, `src/pii-test/reporters/json.ts`
- Tech choices (defer selection):
- Report format details; optional JS-only NER integration toggle
- Tests:
- Unit: runner aggregates pass/fail per expected redaction types.
- e2e: sample profile runs locally against a mock server (fixture) and produces a JSON report.
- Acceptance:
- CLI works without modifying runtime proxy.

### 2.7.0 (Minor) — Dashboard & External Exporters

- Deliverables:
- `GET /dashboard` (minimal HTML) with aggregated MCP→tools, counts, error rates.
- External exporters adapters (e.g., Mixpanel/ClickHouse) off by default.
- Key files:
- `src/dashboard/dashboard.controller.ts` (HTML)
- `src/analytics/exporters/*` (adapters)
- Tech choices (defer selection):
- Template engine vs static HTML
- Tests:
- e2e: dashboard loads; contains expected aggregates from seeded events.
- Unit: exporter adapter formats payloads correctly.
- Acceptance:
- Off by default; no impact on proxy behavior.

### 3.0.0 (Major) — Breaking Changes (candidates)

- Enforce strict config validation failures by default; remove warn-only default.
- Remove v1 compatibility and deprecated fields.
- Change defaults (e.g., server type, redaction enabled by default) only with migration notes.
- Migration guide required.

---

## Testing Strategy

- Unit, integration, and e2e per milestone as listed.
- CI Matrix:
- Node LTS, Linux + macOS (arm64 optional), minimal and full env variable sets.
- Smoke tests for HTTP, SSE, stdio modes.
- Golden inputs/outputs: snapshot critical JSON responses (e.g., `/metrics.json`, `/performance/recommendation`).

---

## Technology Selection Gates (Agent/User Dialog Required)

For each milestone, the agent must ask the user to select among suggested options before implementation:

- Schema validation: JSON Schema (AJV) vs zod+adapter.
- Analytics store: JSONL vs SQLite.
- Export: simple HTTP vs queue-based.
- Metrics & benchmarking: built-in timing vs library.
- Dashboard view: static HTML vs templated engine.
- PII NER (optional): transformers.js/ONNX/WASM vs rule-based only.
- Extension tech: VS Code Webview vs framework in Webview.

Agents must not lock a choice without user confirmation.

---

## Contribution & Commit Discipline

- Every implementation commit referencing this plan updates the plan TODOs (IDs below) and includes a one-line status in the PR body.
- Breaking changes require a MIGRATION.md update and semantic version bump plan.
- New endpoints must document examples in `docs/` and add e2e coverage.

---

## File Touch Map (first milestones)

- 2.2.0
- Add `src/config/schema.{ts|json}` and hook into `src/config/config.service.ts`
- Add `src/debug/debug.controller.ts` or extend `src/app.controller.ts`
- 2.3.0
- Create `src/analytics/*` (interfaces, store adapters, exporter)
- Wire into `src/mcp/mcp-client-wrapper.ts`, `src/redaction/*`
- 2.4.0
- Extend `src/main.ts` (CLI) and `src/config/config.service.ts` (resolver)

---

## Migration Notes

- 2.2.0: New debug endpoints are additive; validation is warn-only by default.
- 2.3.0: Analytics off unless enabled; no behavior change otherwise.
- 2.4.0: Discovery order only applies when project config exists; `--config` retains priority.
- 3.0.0: Any enforcement flips or removals must ship with clear migration steps.

### To-dos

- [ ] Add config schema and warn-only validation hook
- [ ] Add /config and /metrics.json endpoints with sanitization
- [ ] Add unit/e2e tests for validation and debug endpoints
- [ ] Implement analytics interface and local store adapter
- [ ] Add optional HTTP exporter with batching
- [ ] Add unit/e2e for analytics events and exporter
- [ ] Implement init --project and write project config
- [ ] Add config discovery order and resolver
- [ ] Add unit/e2e for project/global/override resolution
- [ ] Implement /performance/recommendation endpoint and cache
- [ ] Add unit/e2e for performance recommendation
- [ ] Add pii_test_profiles schema and CLI runner
- [ ] Add unit/e2e for pii-test and JSON report
- [ ] Add /dashboard and exporters adapters scaffold
- [ ] Add e2e for dashboard and unit for exporters
- [ ] Create mcp-proxy-vscode repo with scaffold
- [ ] Create mcp-proxy-pii-tester repo with scaffold
- [ ] Require plan TODO updates per PR implementing tasks