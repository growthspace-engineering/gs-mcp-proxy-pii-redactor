<!-- 672e31b1-6588-4000-a875-7030cfef3399 0756cdb0-cd3e-4af2-a712-c27b5d3996c9 -->
# Add stdio server mode to MCP proxy and e2e tests

## Scope

- Add `stdio` as a valid server type for the proxy so it can be launched by Cursor as a subprocess without an HTTP server.
- When `stdio` is selected, expose exactly one downstream MCP server instance over stdio.
- Add a CLI flag to choose the downstream when multiple are configured.
- Add e2e tests covering stdio mode using GitHub MCP (requires `GITHUB_TOKEN`).

## Changes

### 1) Types and config

- Update `src/config/types.ts`:
- Extend `MCPServerType` to include `stdio`.
- Update `docs/configuration.md`:
- Document `stdio` server type and selection behavior.
- Add config example for stdio and `.cursor/mcp.json` example for Cursor.

### 2) Bootstrap for stdio mode

- Update `src/main.ts`:
- Add `--stdio-target <name>` CLI option.
- After loading config, if `mcpProxy.type === 'stdio'`:
- Resolve target: `--stdio-target` if provided; otherwise error if not exactly one downstream.
- Retrieve `MCPServerService.getAllServers()`; get target instance.
- Create `StdioServerTransport` and `await instance.server.connect(transport)`.
- Do NOT call `app.listen`; keep process alive and wire SIGINT/SIGTERM to clean shutdown.

### 3) MCP service adjustments

- `src/mcp/mcp-server.service.ts`:
- No functional changes required; ensure server instance map is accessible by `main.ts`.

### 4) E2E tests (stdio)

- Add `test/mcp.stdio.e2e-spec.ts`:
- Skip if `!process.env.GITHUB_TOKEN`.
- Build a temp config based on `config.json`:
- Set `mcpProxy.type = 'stdio'`.
- Restrict `mcpServers` to a single `github-allow` clone allowing `list_issues` and `search_repositories`.
- Start the Nest app via `Test.createTestingModule` and `createNestApplication`.
- Load temp config.
- Instead of `app.listen`, simulate the `stdio` bootstrap path by:
- Import `@modelcontextprotocol/sdk/server/stdio.js` in test and connect `StdioServerTransport` to the selected server instance from `MCPServerService`.
- Use MCP SDK client with `StdioClientTransport` to connect and:
- Assert `listTools` returns only allowed tools.
- Optionally call `search_repositories` with a benign query.
- Close client and app.

### 5) CI considerations

- Mark stdio e2e as `it` with 60s timeout; skip if token missing.
- Document in README how to run locally: `GITHUB_TOKEN=... npm run test:e2e`.

## Developer ergonomics

- Add `npm` script `start:stdio`:
- `node dist/main.js --config config.json --stdio-target github-allow`.
- Add `.cursor/mcp.json` example showing spawning via `node dist/main.js --config config.json --stdio-target github-allow`.

## Acceptance criteria

- Running with `type=stdio` and `--stdio-target` starts without HTTP server and serves MCP over stdio.
- `mcp.stdio.e2e-spec.ts` passes when `GITHUB_TOKEN` is set, verifying listTools against GitHub MCP through the proxy.
- Existing HTTP/SSE e2e tests remain green.

### To-dos

- [ ] Add stdio to MCPServerType and update docs/configuration.md
- [ ] Add stdio mode and --stdio-target to src/main.ts
- [ ] Document stdio mode usage and Cursor setup in README and docs
- [ ] Add test/mcp.stdio.e2e-spec.ts using GitHub MCP and StdioClientTransport
- [ ] Add start:stdio script with --stdio-target example